<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Melinotes | Recital Youtube</title>
  <!-- Libs -->
  <script src="libs/papaparse.min.js"></script>
  <script src="libs/tailswind.min.js"></script>

  <!-- Styles -->
  <style>
    li > b {
      color: #6B46C1;
    }
  </style>
  
  <!-- Logic to import CSV -->
  <script>
    function handleFileImport(event) {
      const fileInput = document.getElementById('file');
      const tableBody = document.getElementById('results');

      const file = fileInput.files[0];
      if (file.type !== 'text/csv') {
        alert('Le fichier doit √™tre un fichier CSV.');
        return;
      }

      Papa.parse(file, {
        header: true,
        complete: function(results) {
          tableBody.innerHTML = '';

          const filteredResults = filterResults(results);
          const mappedResults = mapResults(filteredResults);

          console.log(results);

          renderResults(mappedResults);
        }
      });
    }

    /**
     * Filter the results to keep only the rows that are relevant.
     * The rows must have the following conditions:
     * - 'Lien Youtube' is empty
     * - 'Compl√©t√©' is 'Yes'
     * - 'Nom fichier vid√©o' is not empty
     */
    function filterResults(results) {
      return results.data
                    .filter(row => row['Lien Youtube'].trim() === '')
                    .filter(row => row['Compl√©t√©'] === 'Yes')
                    .filter(row => row['Nom fichier vid√©o'] !== '');
    }

    /**
     * Map the results to a new format.
     */
    function mapResults(results) {
      return results.map(row => {
        return {
          'nom': row['Nom √©l√®ve'],
          'titre': row['Titre pi√®ce'],
          'arrangeur': row['Arrangeur'] || 'N/A',
          'compositeur': row['Compositeur'] || 'N/A',
          'date': extractFrenchDateFromVideoTitle(row['Nom fichier vid√©o'])
        };
      });
    }

    /**
     * Extract the French date from the video title.
     * The date is expected to be in the format 'Le dd MMMM, YYYY'.
     * The video title is expected to be in the format '2024-06-10 17-00-33.mp4'.
     */
    function extractFrenchDateFromVideoTitle(title) {
      const date = title.split('.')[0];
      const [year, month, day] = date.split('-').map(part => parseInt(part));
      const months = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
      return `Le ${day} ${months[month - 1]}, ${year}`;
    }

    /**
     * Render the results in the table.
     */
    function renderResults(results) {
      const tableBody = document.getElementById('results');
      const youtubeTitleFormat = document.getElementById('youtube--title-format').value;
      const youtubeDescriptionFormat = document.getElementById('youtube--description-format').value;

      results.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'border-b dark:border-slate-600';

        const td1 = document.createElement('td');
        const td2 = document.createElement('td');
        const td3 = document.createElement('td');
        [td1, td2, td3].forEach(td => {
          td.className = 'py-4 px-4 whitespace-pre text-wrap';
        });

        td1.textContent = row['nom'] + " / " + row['titre'];
        td2.textContent = formatYoutubeTitle(youtubeTitleFormat, row);
        td3.textContent = formatYoutubeDescription(youtubeDescriptionFormat, row);

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);

        tableBody.appendChild(tr);
      });
    }

    /**
     * Format the YouTube title using the provided format.
     */
    function formatYoutubeTitle(titleFormat, row) {
      return titleFormat
                .replace('{titre}', row['titre'])
                .replace('{nom}', row['nom']);
    }

    /**
     * Format the YouTube description using the provided format.
     */
    function formatYoutubeDescription(descriptionFormat, row) {
      return descriptionFormat
                .replace('{nom}', row['nom'])
                .replace('{titre}', row['titre'])
                .replace('{compositeur}', row['compositeur'])
                .replace('{arrangeur}', row['arrangeur'])
                .replace('{date}', row['date']);
    }
  </script>
</head>
<body class="bg-slate-50">
  <main class="container w-2/3 flex flex-col mx-auto pt-24 pb-10">
    <h1 class="text-6xl text-purple-900 pb-8">Comment √ßa marche</h1>
    <ul class="list-disc text-xl text-slate-700 ml-7">
      <li>Dans <b>Notion</b>, cliquer sur le menu <b>[...]</b> en haut √† droite de la page.</li>
      <li>Choisir <b>Exporter</b>.</li>
      <li>Choisir <b>CSV</b>.</li>
      <li>Enregistrer le fichier sur votre ordinateur.</li>
      <li>√Ä l'aide du formulaire ci-bas, s√©lectionner le fichier <b>CVS</b>.</li>
      <li>Cliquer sur le bouton <b>Importer</b>.</li>
    </ul>

    <hr class="my-8" />

    <div>
      <label for="file" class="block text-md text-purple-900 font-bold mb-2">Fichier CSV</label>
      <input type="file" id="file" class="w-full bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
      <label for="youtube--title-format" class="block text-md text-purple-900 font-bold mt-4 mb-2">Format Titre YouTube</label>
      <input 
        id="youtube--title-format"
        type="text"
        class="w-full bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        value="&ldquo;{titre}&rdquo; interpr√©t√© par {nom}"
      >
      <label for="youtube--description-format" class="block text-md text-purple-900 font-bold mt-4 mb-2">Format Description YouTube</label>
      <textarea id="youtube--description-format" rows="8" class="w-full bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
üéπ Musicien(s): {nom}
üéº Titre de la pi√®ce de musique interpr√©t√©e: {titre}
üéª Compositeur: {compositeur}
üìù Arrangeur: {arrangeur}
üè† √âcole: Melinotes, Longueuil
üìÖ Date de l'enregistrement: {date}

Nous esp√©rons que vous appr√©cierez cette belle prestation! Pensez √† liker et √† commenter pour partager vos r√©actions üòä</textarea>
      <label class="block text-md text-slate-500 font-bold mt-4 mb-2">L√©gende</label>
      <button class="mt-4 transition bg-purple-900 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="handleFileImport()">Importer</button>
    </div>

    <hr class="my-8" />
    
    <h1 class="text-6xl text-purple-900 mb-6">Donn√©es</h1>
    <table class="w-full table-fixed text-left border dark:border-slate-600">
      <thead>
        <tr class="border-b dark:border-slate-600 text-purple-700 bg-purple-200">
          <th class="w-1/4 py-4 px-4">√âl√®ve(S) / Pi√®ce</th>
          <th class="w-1/4 py-4 px-4">Titre YouTube</th>
          <th class="w-1/2 py-4 px-4">Description YouTube</th>
        </tr>
      </thead>
      <tbody id="results">
        <!-- Results will be displayed here -->
      </tbody>
    </table>
  </main>
</body>
</html>